name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake pkg-config \
            libmtp-dev libfuse3-dev libsqlite3-dev libssl-dev \
            libimobiledevice-dev libplist-dev usbmuxd \
            qt6-base-dev qt6-base-dev-tools qt6-tools-dev \
            libgl1-mesa-dev libxkbcommon-dev \
            wget fuse libfuse2 imagemagick
      
      - name: Build CLI
        run: |
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_GUI=OFF
          make -j$(nproc)
      
      - name: Build GUI
        run: |
          mkdir build-gui && cd build-gui
          export Qt6_DIR=/usr/lib/x86_64-linux-gnu/cmake/Qt6
          export CMAKE_PREFIX_PATH=/usr/lib/x86_64-linux-gnu/cmake
          cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_GUI=ON \
            -DQt6_DIR=$Qt6_DIR \
            -DCMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH
          cmake --build . --target photo_transfer -- -j$(nproc)
          cmake --build . --target photo_transfer_gui -- -j$(nproc)
      
      - name: Create AppImage
        run: |
          cd build-gui
          
          # Check if GUI was built
          if [ ! -f photo_transfer_gui ]; then
            echo "ERROR: photo_transfer_gui not built!"
            ls -la
            exit 1
          fi
          
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Copy executables
          cp photo_transfer AppDir/usr/bin/
          cp photo_transfer_gui AppDir/usr/bin/
          
          # Create a simple icon (256x256 PNG) - blue gradient square
          convert -size 256x256 gradient:#4A90D9-#2E5A87 \
            AppDir/usr/share/icons/hicolor/256x256/apps/photo-transfer.png
          
          # Create desktop file using echo (avoids YAML parsing issues)
          echo "[Desktop Entry]" > AppDir/usr/share/applications/photo-transfer.desktop
          echo "Type=Application" >> AppDir/usr/share/applications/photo-transfer.desktop
          echo "Name=Photo Transfer" >> AppDir/usr/share/applications/photo-transfer.desktop
          echo "Comment=Transfer photos from mobile devices" >> AppDir/usr/share/applications/photo-transfer.desktop
          echo "Exec=photo_transfer_gui" >> AppDir/usr/share/applications/photo-transfer.desktop
          echo "Icon=photo-transfer" >> AppDir/usr/share/applications/photo-transfer.desktop
          echo "Categories=Utility;Graphics;" >> AppDir/usr/share/applications/photo-transfer.desktop
          echo "Terminal=false" >> AppDir/usr/share/applications/photo-transfer.desktop
          
          # Copy icon to root for linuxdeploy
          cp AppDir/usr/share/icons/hicolor/256x256/apps/photo-transfer.png AppDir/
          
          # Download linuxdeploy
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage
          
          # Set Qt plugin path
          export QMAKE=/usr/lib/qt6/bin/qmake
          export QT_SELECT=qt6
          
          # Build AppImage
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --icon-file AppDir/photo-transfer.png \
            --desktop-file AppDir/usr/share/applications/photo-transfer.desktop \
            --plugin qt \
            --output appimage
          
          # Rename output
          mv Photo_Transfer*.AppImage PhotoTransfer-1.0.0-Linux.AppImage 2>/dev/null || \
          mv *.AppImage PhotoTransfer-1.0.0-Linux.AppImage 2>/dev/null || true
          
          # Verify
          ls -la *.AppImage || echo "Warning: No AppImage created"
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            build-gui/*.AppImage

  build-macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          brew install cmake libmtp libimobiledevice openssl@3 sqlite3 qt@6
      
      - name: Build
        run: |
          mkdir build && cd build
          export PKG_CONFIG_PATH="$(brew --prefix libmtp)/lib/pkgconfig:$(brew --prefix libimobiledevice)/lib/pkgconfig:$PKG_CONFIG_PATH"
          export LIBRARY_PATH="$(brew --prefix libmtp)/lib:$(brew --prefix libimobiledevice)/lib:$LIBRARY_PATH"
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_GUI=ON \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
            -DQt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6 \
            -DCMAKE_LIBRARY_PATH="$(brew --prefix libmtp)/lib;$(brew --prefix libimobiledevice)/lib"
          make -j$(sysctl -n hw.ncpu)
      
      - name: Create DMG
        run: |
          cd build
          
          # Use the Qt-generated .app bundle if it exists
          if [ -d "photo_transfer_gui.app" ]; then
            echo "Using Qt-generated app bundle"
            APP_BUNDLE="photo_transfer_gui.app"
          else
            echo "Creating app bundle manually"
            mkdir -p "Photo Transfer.app/Contents/MacOS"
            mkdir -p "Photo Transfer.app/Contents/Resources"
            APP_BUNDLE="Photo Transfer.app"
            
            if [ -f photo_transfer_gui ]; then
              cp photo_transfer_gui "$APP_BUNDLE/Contents/MacOS/"
            fi
          fi
          
          # Copy CLI tool into the bundle
          if [ -f photo_transfer ]; then
            cp photo_transfer "$APP_BUNDLE/Contents/MacOS/"
          fi
          
          # Create/update Info.plist
          printf '%s\n' '<?xml version="1.0" encoding="UTF-8"?>' > "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '<plist version="1.0">' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '<dict>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '    <key>CFBundleExecutable</key>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '    <string>photo_transfer_gui</string>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '    <key>CFBundleIdentifier</key>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '    <string>com.phototransfer.app</string>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '    <key>CFBundleName</key>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '    <string>Photo Transfer</string>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '    <key>CFBundleVersion</key>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '    <string>1.0.0</string>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '    <key>CFBundlePackageType</key>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '    <string>APPL</string>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '    <key>NSHighResolutionCapable</key>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '    <true/>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '</dict>' >> "$APP_BUNDLE/Contents/Info.plist"
          printf '%s\n' '</plist>' >> "$APP_BUNDLE/Contents/Info.plist"
          
          # Deploy Qt frameworks
          $(brew --prefix qt@6)/bin/macdeployqt "$APP_BUNDLE" -verbose=2
          
          # Rename to final name if needed
          if [ "$APP_BUNDLE" = "photo_transfer_gui.app" ]; then
            mv "$APP_BUNDLE" "Photo Transfer.app"
          fi
          
          # Create DMG with drag-to-Applications
          mkdir -p dmg_contents
          cp -R "Photo Transfer.app" dmg_contents/
          ln -s /Applications dmg_contents/Applications
          
          hdiutil create -volname "Photo Transfer" \
            -srcfolder dmg_contents \
            -ov -format UDZO \
            PhotoTransfer-1.0.0-macOS.dmg
          
          ls -la *.dmg
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: build/*.dmg

  build-windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.*'
          modules: 'qtimageformats'
      
      - name: Install vcpkg dependencies
        run: |
          vcpkg install sqlite3:x64-windows openssl:x64-windows
      
      - name: Install NSIS
        run: |
          choco install nsis -y
      
      - name: Build
        run: |
          mkdir build
          cd build
          cmake .. `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_GUI=ON `
            -DENABLE_ANDROID=ON `
            -DENABLE_IOS=OFF `
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
          cmake --build . --config Release
      
      - name: Deploy Qt
        run: |
          cd build/Release
          windeployqt photo_transfer_gui.exe --release --no-translations
      
      - name: Create Installer
        shell: pwsh
        run: |
          # Create NSIS installer script
          @'
          !include "MUI2.nsh"
          
          Name "Photo Transfer"
          OutFile "PhotoTransfer-1.0.0-Windows-Setup.exe"
          InstallDir "$PROGRAMFILES64\Photo Transfer"
          RequestExecutionLevel admin
          
          !define MUI_ABORTWARNING
          !define MUI_ICON "${NSISDIR}\Contrib\Graphics\Icons\modern-install.ico"
          
          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_PAGE_FINISH
          
          !insertmacro MUI_UNPAGE_CONFIRM
          !insertmacro MUI_UNPAGE_INSTFILES
          
          !insertmacro MUI_LANGUAGE "English"
          
          Section "Install"
            SetOutPath "$INSTDIR"
            File /r "build\Release\*.*"
            
            CreateDirectory "$SMPROGRAMS\Photo Transfer"
            CreateShortcut "$SMPROGRAMS\Photo Transfer\Photo Transfer.lnk" "$INSTDIR\photo_transfer_gui.exe"
            CreateShortcut "$DESKTOP\Photo Transfer.lnk" "$INSTDIR\photo_transfer_gui.exe"
            
            WriteUninstaller "$INSTDIR\Uninstall.exe"
            
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PhotoTransfer" "DisplayName" "Photo Transfer"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PhotoTransfer" "UninstallString" "$INSTDIR\Uninstall.exe"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PhotoTransfer" "DisplayVersion" "1.0.0"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PhotoTransfer" "Publisher" "Photo Transfer"
          SectionEnd
          
          Section "Uninstall"
            RMDir /r "$INSTDIR"
            RMDir /r "$SMPROGRAMS\Photo Transfer"
            Delete "$DESKTOP\Photo Transfer.lnk"
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PhotoTransfer"
          SectionEnd
          '@ | Out-File -FilePath "installer.nsi" -Encoding ASCII
          
          # Run NSIS
          & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi
          
          # Also create portable ZIP
          cd build/Release
          Compress-Archive -Path * -DestinationPath ..\..\PhotoTransfer-1.0.0-Windows-Portable.zip
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            PhotoTransfer-1.0.0-Windows-Setup.exe
            PhotoTransfer-1.0.0-Windows-Portable.zip

  release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: List downloaded files
        run: |
          echo "=== All downloaded files ==="
          find . -type f \( -name "*.AppImage" -o -name "*.dmg" -o -name "*.exe" -o -name "*.zip" \)
          echo "=== Directory structure ==="
          ls -laR
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux-build/*.AppImage
            macos-build/*.dmg
            windows-build/*.exe
            windows-build/*.zip
          draft: false
          generate_release_notes: true
          body: |
            ## Download Instructions
            
            ### Windows
            - **Recommended**: Download `PhotoTransfer-1.0.0-Windows-Setup.exe` - Double-click to install
            - **Portable**: Download `PhotoTransfer-1.0.0-Windows-Portable.zip` - Extract and run
            
            ### macOS
            - Download `PhotoTransfer-1.0.0-macOS.dmg`
            - Double-click to open, drag "Photo Transfer" to Applications
            - First run: Right-click > Open (to bypass Gatekeeper)
            
            ### Linux
            - Download `PhotoTransfer-1.0.0-Linux.AppImage`
            - Make executable: `chmod +x PhotoTransfer-1.0.0-Linux.AppImage`
            - Double-click or run: `./PhotoTransfer-1.0.0-Linux.AppImage`
          fail_on_unmatched_files: false
