name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake pkg-config \
            libmtp-dev libfuse3-dev libsqlite3-dev libssl-dev \
            libimobiledevice-dev libplist-dev usbmuxd \
            qt6-base-dev qt6-base-dev-tools qt6-tools-dev \
            libgl1-mesa-dev libxkbcommon-dev \
            wget fuse libfuse2
      
      - name: Build CLI
        run: |
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_GUI=OFF
          make -j$(nproc)
      
      - name: Build GUI
        run: |
          mkdir build-gui && cd build-gui
          export Qt6_DIR=/usr/lib/x86_64-linux-gnu/cmake/Qt6
          export CMAKE_PREFIX_PATH=/usr/lib/x86_64-linux-gnu/cmake
          cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_GUI=ON \
            -DQt6_DIR=$Qt6_DIR \
            -DCMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH
          cmake --build . --target photo_transfer -- -j$(nproc)
          cmake --build . --target photo_transfer_gui -- -j$(nproc)
      
      - name: Create AppImage
        run: |
          cd build-gui
          mkdir -p AppDir/usr/bin
          if [ ! -f photo_transfer_gui ]; then
            echo "photo_transfer_gui not built. Check Qt install or CMake output."
            ls -la
            exit 1
          fi
          cp photo_transfer photo_transfer_gui AppDir/usr/bin/
          
          # Download linuxdeploy
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x *.AppImage
          
          # Create desktop file
          mkdir -p AppDir/usr/share/applications
          cat > AppDir/usr/share/applications/photo-transfer.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=Photo Transfer
          Comment=Transfer photos from mobile devices
          Exec=photo_transfer_gui
          Icon=photo-transfer
          Categories=Utility;
          Terminal=false
          EOF
          
          # Build AppImage
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --plugin qt --output appimage || true
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            build/photo_transfer
            build-gui/photo_transfer_gui
            build-gui/*.AppImage

  build-macos:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          brew install cmake libmtp libimobiledevice openssl@3 sqlite3 qt@6
      
      - name: Build
        run: |
          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_GUI=ON \
            -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
            -DQt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6
          make -j$(sysctl -n hw.ncpu)
      
      - name: Create DMG
        run: |
          cd build
          mkdir -p "Photo Transfer.app/Contents/MacOS"
          mkdir -p "Photo Transfer.app/Contents/Resources"
          cp photo_transfer photo_transfer_gui "Photo Transfer.app/Contents/MacOS/"
          
          # Create Info.plist
          cat > "Photo Transfer.app/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>photo_transfer_gui</string>
              <key>CFBundleIdentifier</key>
              <string>com.phototransfer.app</string>
              <key>CFBundleName</key>
              <string>Photo Transfer</string>
              <key>CFBundleVersion</key>
              <string>1.0.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
          </dict>
          </plist>
          EOF
          
          # Deploy Qt
          macdeployqt "Photo Transfer.app" || true
          
          # Create DMG
          hdiutil create -volname "Photo Transfer" \
            -srcfolder "Photo Transfer.app" \
            -ov -format UDZO \
            PhotoTransfer-1.0.0-macOS.dmg || true
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            build/photo_transfer
            build/photo_transfer_gui
            build/*.dmg

  build-windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.*'
          modules: 'qtimageformats'
      
      - name: Install vcpkg dependencies
        run: |
          vcpkg install sqlite3:x64-windows openssl:x64-windows
      
      - name: Build
        run: |
          mkdir build
          cd build
          cmake .. `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_GUI=ON `
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
          cmake --build . --config Release
      
      - name: Deploy Qt
        run: |
          cd build/Release
          windeployqt photo_transfer_gui.exe --release
      
      - name: Create ZIP
        run: |
          cd build/Release
          Compress-Archive -Path * -DestinationPath PhotoTransfer-1.0.0-Windows.zip
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            build/Release/photo_transfer.exe
            build/Release/photo_transfer_gui.exe
            build/Release/*.zip

  release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux-build/*.AppImage
            macos-build/*.dmg
            windows-build/*.zip
          draft: true
          generate_release_notes: true
